<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            min-height: 80vh;
        }
        .chat-box {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 400px; /* Fixed height for chat area */
            margin-bottom: 1rem;
        }
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            line-height: 1.4;
        }
        .message-user {
            background-color: #3b82f6;
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .message-ai {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        .input-field, .select-field {
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
            width: 100%;
        }
        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        .btn-primary {
            background-color: #2563eb;
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .message-box {
            background-color: #dbeafe;
            color: #1e40af;
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="container">
        <h1 class="text-3xl sm:text-4xl font-extrabold mb-2 text-center text-gray-800">Friend AI</h1>
        <p class="text-gray-600 mb-6 text-center">Your conversational AI companion. Chat freely and openly.</p>

        <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
            <div class="flex items-center space-x-2">
                <label for="user-gender-select" class="block font-semibold">I am:</label>
                <select id="user-gender-select" class="select-field w-auto">
                    <option value="male" selected>Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="ai-gender-select" class="block font-semibold">Talk to a:</label>
                <select id="ai-gender-select" class="select-field w-auto">
                    <option value="male" selected>Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
        </div>

        <div id="chat-box" class="chat-box mb-4">
            <!-- Chat messages will be added here -->
            <div class="message message-ai">Hello there! I'm here to listen. How are you doing today?</div>
        </div>

        <div id="message-box" class="message-box hidden"></div>

        <div class="flex space-x-4">
            <input type="text" id="user-input" class="input-field flex-grow" placeholder="Type your message...">
            <button id="send-btn" class="btn btn-primary flex items-center justify-center">
                <span id="btn-text">Send</span>
                <div id="loading-spinner" class="loading-spinner ml-2 hidden"></div>
            </button>
        </div>
    </div>
    
    <footer class="mt-8 text-center text-gray-500 text-sm">
        Made with love by uzair b2b services
    </footer>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userGenderSelect = document.getElementById('user-gender-select');
        const aiGenderSelect = document.getElementById('ai-gender-select');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const messageBox = document.getElementById('message-box');

        const apiKey = "";
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        let chatHistory = [];
        
        // Helper function to show messages
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            if (type === 'error') {
                messageBox.style.backgroundColor = '#fecaca';
                messageBox.style.color = '#7f1d1d';
            } else {
                messageBox.style.backgroundColor = '#dbeafe';
                messageBox.style.color = '#1e40af';
            }
        }

        // Fetch API with exponential backoff
        async function fetchWithBackoff(url, payload, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(url, payload, retries - 1, delay * 2);
                    } else {
                        throw new Error(`API error: ${response.statusText}`);
                    }
                }
                const result = await response.json();
                return result;
            } catch (error) {
                console.error("API call failed:", error);
                throw error;
            }
        }
        
        function appendMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `message-${sender}`);
            messageElement.textContent = text;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            const userGender = userGenderSelect.value;
            const aiGender = aiGenderSelect.value;

            // Append user message
            appendMessage('user', userMessage);
            userInput.value = '';

            // Set button to loading state
            sendBtn.disabled = true;
            btnText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            messageBox.classList.add('hidden');

            try {
                // Construct the initial prompt with user and AI gender
                const initialPrompt = `Hello. You are an AI friend. The user is a ${userGender}. You are a ${aiGender} friend. I want you to respond like a human friend who is supportive and empathetic. Your responses should be conversational, friendly, and not overly formal. The user is feeling lonely and wants to talk. Respond to their questions and messages accordingly. You must maintain the persona of a human friend.`;

                // Add the initial prompt to the chat history only at the beginning of the conversation
                if (chatHistory.length === 0) {
                    chatHistory.push({
                        role: "user",
                        parts: [{ text: initialPrompt }]
                    });
                }
                
                // Add the user's message to the chat history
                chatHistory.push({
                    role: "user",
                    parts: [{ text: userMessage }]
                });

                const payload = {
                    contents: chatHistory
                };

                const result = await fetchWithBackoff(geminiApiUrl, payload);
                const aiResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponse) {
                    appendMessage('ai', aiResponse);
                    // Update chat history with AI's message
                    chatHistory.push({
                        role: "model",
                        parts: [{ text: aiResponse }]
                    });
                } else {
                    appendMessage('ai', "I'm sorry, I was unable to respond. Please try again.");
                }
            } catch (error) {
                console.error(error);
                appendMessage('ai', "An error occurred. Please try again.");
            } finally {
                // Reset button state
                sendBtn.disabled = false;
                btnText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
