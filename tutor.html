<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School AI Tutor</title>
    <!-- Font links for Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CDN for Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CDN for Vue.js to handle reactivity and logic -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        
        .message-bubble {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
        }
        
        .user-message {
            background-color: #2563eb;
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem;
        }
        
        .ai-message {
            background-color: #d1fae5;
            color: #065f46;
            align-self: flex-start;
            border-bottom-left-radius: 0.5rem;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen">

    <!-- Vue.js app container -->
    <div id="app" class="flex flex-col flex-grow w-full max-w-4xl mx-auto rounded-xl shadow-lg overflow-hidden bg-white mt-6 mb-6 md:mt-12 md:mb-6">
        <!-- Header with title, home button, and credits -->
        <div class="flex items-center justify-between p-4 sm:p-6 border-b border-gray-200 flex-wrap">
            <h1 class="text-xl sm:text-3xl font-extrabold text-gray-900 mb-2 sm:mb-0">UZAIR B2B A.I. (AI Tutor)</h1>
            <div class="flex items-center space-x-4">
                <!-- Home button to reset the application state -->
                <button
                    @click="resetChat"
                    class="p-2 text-blue-600 rounded-full hover:bg-gray-200 transition-colors duration-200"
                    aria-label="Home"
                >
                    <i class="fas fa-home text-2xl"></i>
                </button>
                <div class="text-right">
                    <p class="text-xs sm:text-sm text-gray-500">
                        Made with love by
                        <span class="text-blue-600">uzair b2b services</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Main chat window -->
        <div id="chat-window" class="flex-grow overflow-y-auto p-4 sm:p-6 border-b border-gray-200 bg-gray-50 flex flex-col gap-4">
            <!-- Initial AI message -->
            <div class="message-bubble ai-message">
                Hello! I am a tutor AI designed to help you with your studies for ICSE and ISC. I can assist with subjects like English, Hindi, Maths, Computer Science, and more. What would you like to learn today?
            </div>
            <!-- Dynamic chat messages rendered by Vue.js -->
            <div v-for="(message, index) in chatHistory" :key="index" :class="['message-bubble', message.sender === 'user' ? 'user-message' : 'ai-message']">
                {{ message.text }}
            </div>
            <!-- Loading indicator when AI is thinking -->
            <div v-if="isLoading" class="message-bubble ai-message flex items-center space-x-2">
                <svg class="animate-spin h-5 w-5 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Typing...</span>
            </div>
        </div>

        <!-- Input and send button container -->
        <div class="p-4 sm:p-6 border-t border-gray-200 bg-white">
            <div class="flex space-x-4">
                <input
                    type="text"
                    v-model="userInput"
                    @keyup.enter="sendMessage"
                    class="flex-grow px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                    placeholder="Ask me a question..."
                >
                <button
                    @click="sendMessage"
                    :disabled="isLoading || !userInput.trim()"
                    class="px-6 py-2 rounded-full bg-blue-600 text-white font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    Send
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="mt-auto text-center text-gray-500 text-sm py-4">
        Made with love by uzair b2b services
    </footer>

    <script>
        const { createApp, ref, nextTick } = Vue;

        createApp({
            setup() {
                // Reactive state variables for the app
                const chatHistory = ref([]);
                const userInput = ref('');
                const isLoading = ref(false);
                
                // API key will be provided by the runtime
                const apiKey = "AIzaSyDpwJN-nzzEkckITvjvGoIlLThYKDdzjUo";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                /**
                 * Handles fetching a response from the API with exponential backoff.
                 */
                const fetchWithBackoff = async (payload, retries = 5, delay = 1000) => {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429 && retries > 0) {
                                await new Promise(res => setTimeout(res, delay));
                                return fetchWithBackoff(payload, retries - 1, delay * 2);
                            } else {
                                throw new Error(`API error: ${response.statusText}`);
                            }
                        }

                        const result = await response.json();
                        return result;
                    } catch (error) {
                        throw error;
                    }
                };
                
                /**
                 * Scrolls the chat window to the bottom.
                 */
                const scrollToBottom = async () => {
                    await nextTick();
                    const chatWindow = document.getElementById('chat-window');
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                };

                /**
                 * Sends the user's message and gets a response from the AI.
                 */
                const sendMessage = async () => {
                    const userText = userInput.value.trim();
                    if (!userText) return;

                    // Add user message to chat history
                    chatHistory.value.push({
                        text: userText,
                        sender: 'user'
                    });
                    userInput.value = ''; // Clear input field
                    
                    scrollToBottom();

                    // Show loading state
                    isLoading.value = true;

                    const prompt = `You are an AI tutor for ICSE and ISC students for all subjects including English, Hindi, Maths, Computer Science, and others. Your goal is to provide helpful, accurate, and concise educational answers. The student's question is: ${userText}`;
                    
                    const chatPayload = [{
                        role: "user",
                        parts: [{ text: prompt }]
                    }];

                    const payload = {
                        contents: chatPayload,
                    };

                    try {
                        const result = await fetchWithBackoff(payload);

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const aiResponse = result.candidates[0].content.parts[0].text;
                            chatHistory.value.push({
                                text: aiResponse,
                                sender: 'ai'
                            });
                        } else {
                            chatHistory.value.push({
                                text: "I'm sorry, I was unable to generate a response. Please try again.",
                                sender: 'ai'
                            });
                        }
                    } catch (error) {
                        console.error(error);
                        chatHistory.value.push({
                            text: "An error occurred. Please try again later.",
                            sender: 'ai'
                        });
                    } finally {
                        // Hide loading state and scroll to bottom
                        isLoading.value = false;
                        scrollToBottom();
                    }
                };
                
                /**
                 * Resets the chat history and app state.
                 */
                const resetChat = () => {
                    chatHistory.value = [];
                    userInput.value = '';
                    isLoading.value = false;
                };

                return {
                    chatHistory,
                    userInput,
                    isLoading,
                    sendMessage,
                    resetChat
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
