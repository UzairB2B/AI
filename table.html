<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TABLE.AI - Content to Structure Converter</title>
    <!-- Inter Font (Assuming availability or falling back to system sans-serif) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Mermaid.js for Flowchart Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    
    <style>
        /* General Setup */
        body { 
            font-family: 'Inter', sans-serif, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f8f8; /* Very light gray background */
            min-height: 100vh;
        }
        #app {
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 40px;
            border: 1px solid #ccc;
        }

        /* Utility Classes */
        .header { text-align: center; margin-bottom: 30px; }
        .title { font-size: 28px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 16px; }
        .section-card {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        .flex-row-center {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        @media (min-width: 640px) {
            .flex-row-center {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 0;
            }
        }
        .text-label { display: block; font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px; }

        /* Input Styles */
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #333; /* Simple black border */
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s;
        }
        textarea:focus {
            border-color: #007bff;
            outline: none;
        }

        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.4);
        }
        .btn-primary:hover:not(:disabled) { background-color: #0056b3; }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            font-size: 14px;
        }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 15px;
        }
        .btn-success:hover:not(:disabled) { background-color: #1e7e34; }

        /* Radio Buttons/Selectors */
        .radio-group label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            margin-right: 15px;
        }

        /* Message/Status Bar */
        .status-bar {
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
            text-align: center;
        }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Result Area */
        .result-header {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        @media (min-width: 640px) {
            .result-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        .download-group { display: flex; gap: 10px; }
        
        /* Table Styles (Preview) - Uses simple black borders */
        .data-table-container {
            overflow-x: auto;
            border: 1px solid black; 
            border-radius: 4px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table thead { background-color: #f0f0f0; }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid black; /* Black border for all cells */
        }
        .data-table tbody tr:hover { background-color: #f5f5f5; }

        /* Code Previews */
        .code-preview-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            margin-top: 15px;
        }
        @media (min-width: 640px) {
            .code-preview-section {
                flex-direction: row;
            }
            .code-preview-section > div { width: 50%; }
        }
        
        .code-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .code-toggle button {
            color: #007bff;
            font-size: 14px;
            font-weight: 500;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        .result-code pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 10px;
            background-color: #eee;
            border-radius: 4px;
            border: 1px solid #333; /* Black border for code block */
            overflow-x: auto;
            font-size: 13px;
        }

        /* Flowchart/Mermaid Styles */
        .mermaid-container {
            border: 1px solid black;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .mermaid {
            background-color: transparent !important;
            margin: 0 auto;
            max-width: 100%;
            overflow-x: auto;
            min-height: 100px; /* Ensure visibility even if graph is small */
        }

        /* Vue Transition Styles */
        .v-enter-active, .v-leave-active {
          transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
          overflow: hidden;
        }
        .v-enter-from, .v-leave-to {
          max-height: 0;
          opacity: 0;
        }
        .v-enter-to, .v-leave-from {
            max-height: 500px; 
            opacity: 1;
        }

        /* Footer */
        .app-footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 12px;
            color: #999;
        }
    </style>
</head>
<body>

    <div id="app">

        <!-- Header -->
        <header class="header">
            <!-- Home Icon and Title Container -->
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 5px;">
                <a href="index.html" style="color: #007bff; font-size: 20px; text-decoration: none; margin-right: 15px;" title="Go to Home">
                    <i class="fas fa-home"></i>
                </a>
                <h1 class="title">TABLE.<span style="color:#007bff;">AI</span></h1>
            </div>
            <p class="subtitle">Convert raw text content into structured tables or visual flowcharts.</p>
        </header>

        <!-- Main Content -->
        <div class="space-y-6">

            <!-- Input Area -->
            <div class="section-card">
                <label for="content-input" class="text-label">1. Paste Your Content Here</label>
                <textarea 
                    id="content-input" 
                    v-model="content" 
                    :disabled="isLoading"
                    rows="8" 
                    placeholder="E.g., A list of steps for a process, a summary of a product, or sequential instructions..."
                ></textarea>
                <p style="font-size: 12px; color: #999; margin-top: 5px;">Note: Longer, clearer text yields better structured results.</p>
            </div>

            <!-- Options and Action -->
            <div class="section-card flex-row-center">
                
                <!-- Output Type Selector -->
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                    <span class="text-label" style="margin-bottom: 5px;">2. Select Output Type:</span>
                    <div class="radio-group">
                        <label>
                            <input 
                                type="radio" 
                                v-model="outputType" 
                                value="Table" 
                                :disabled="isLoading"
                            >
                            <span style="margin-left: 5px; color: #333;">Table (JSON/HTML)</span>
                        </label>
                        <label>
                            <input 
                                type="radio" 
                                v-model="outputType" 
                                value="Flowchart" 
                                :disabled="isLoading"
                            >
                            <span style="margin-left: 5px; color: #333;">Flowchart (SVG)</span>
                        </label>
                    </div>
                </div>

                <!-- Process Button -->
                <button 
                    @click="processContent" 
                    :disabled="isLoading || !content.trim()"
                    class="btn btn-primary"
                    style="min-width: 200px;"
                >
                    <i v-if="isLoading" class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                    <i v-else class="fas fa-magic" style="margin-right: 8px;"></i>
                    {{ isLoading ? 'Processing...' : 'Generate Structure' }}
                </button>
            </div>

            <!-- Status/Message Bar -->
            <div v-if="message" 
                :class="['status-bar', message.type === 'error' ? 'status-error' : 'status-success']">
                {{ message.text }}
            </div>

            <!-- Result Display Area -->
            <div v-if="resultData || errorMessage" class="section-card" style="min-height: 200px;">
                <h2 class="result-header">
                    Generated {{ outputType }}

                    <!-- Download Buttons for Table -->
                    <div v-if="outputType === 'Table' && resultData" class="download-group">
                        <button 
                            @click="copyToClipboard(JSON.stringify(resultData, null, 2), 'JSON')"
                            class="btn btn-success"
                            :disabled="isLoading"
                        >
                            <i class="fas fa-copy" style="margin-right: 5px;"></i> Copy JSON
                        </button>
                        <button 
                            @click="copyToClipboard(generateTableHTML, 'HTML')"
                            class="btn btn-success"
                            :disabled="isLoading"
                        >
                            <i class="fas fa-copy" style="margin-right: 5px;"></i> Copy HTML
                        </button>
                        <button 
                            @click="downloadResult('html')"
                            class="btn btn-secondary"
                            :disabled="isLoading"
                        >
                            <i class="fas fa-download" style="margin-right: 5px;"></i> Download HTML
                        </button>
                    </div>
                    
                    <!-- Download/Copy Buttons for Flowchart -->
                    <div v-else-if="outputType === 'Flowchart' && resultData" class="download-group">
                        <button 
                            @click="copySvgCode"
                            class="btn btn-success"
                            :disabled="isLoading"
                        >
                            <i class="fas fa-copy" style="margin-right: 5px;"></i> Copy SVG Code
                        </button>
                        <button 
                            @click="downloadResult('svg')"
                            class="btn btn-secondary"
                            :disabled="isLoading"
                        >
                            <i class="fas fa-download" style="margin-right: 5px;"></i> Download SVG
                        </button>
                    </div>
                </h2>
                
                <!-- Error Message Display -->
                <div v-if="errorMessage" class="status-bar status-error">
                    <p style="font-weight: bold; margin-bottom: 5px;">Error Processing Request:</p>
                    <p style="font-size: 14px;">{{ errorMessage }}</p>
                    <p style="font-size: 12px; margin-top: 5px;">This often happens if the input is too vague. Please ensure your input is clear.</p>
                </div>

                <!-- Flowchart Visualization -->
                <div v-else-if="outputType === 'Flowchart' && resultData" class="mermaid-container">
                    <div id="mermaid-output" class="mermaid">
                        <p v-if="isLoading" style="text-align: center; color: #999;">Rendering Flowchart...</p>
                    </div>
                </div>

                <!-- Table Visualization (PRIMARY OUTPUT) -->
                <div v-else-if="outputType === 'Table' && Array.isArray(resultData)">
                    <!-- Displayed Table (with simple CSS borders) -->
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th v-for="key in tableHeaders" :key="key">
                                        {{ key }}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(row, index) in resultData" :key="index">
                                    <td v-for="key in tableHeaders" :key="key">
                                        {{ row[key] }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Raw Previews & Copy Buttons -->
                    <div class="code-preview-section">
                        <!-- JSON Preview Toggle and Copy Button -->
                        <div>
                            <div class="code-toggle">
                                <button @click="togglePreview('json')">
                                    Raw JSON Preview <i :class="['fas', showPreview === 'json' ? 'fa-chevron-up' : 'fa-chevron-down']" style="margin-left: 5px;"></i>
                                </button>
                                <button
                                    v-if="showPreview === 'json'"
                                    @click="copyToClipboard(JSON.stringify(resultData, null, 2), 'JSON')"
                                    class="btn btn-success"
                                >
                                    <i class="fas fa-copy" style="margin-right: 5px;"></i> Copy JSON
                                </button>
                            </div>
                            <Transition>
                                <div v-if="showPreview === 'json'" class="result-code" style="margin-top: 8px;">
                                    <pre>{{ JSON.stringify(resultData, null, 2) }}</pre>
                                </div>
                            </Transition>
                        </div>

                        <!-- HTML Preview Toggle and Copy Button -->
                        <div>
                            <div class="code-toggle">
                                <button @click="togglePreview('html')">
                                    HTML Code Preview <i :class="['fas', showPreview === 'html' ? 'fa-chevron-up' : 'fa-chevron-down']" style="margin-left: 5px;"></i>
                                </button>
                                <button
                                    v-if="showPreview === 'html'"
                                    @click="copyToClipboard(generateTableHTML, 'HTML')"
                                    class="btn btn-success"
                                >
                                    <i class="fas fa-copy" style="margin-right: 5px;"></i> Copy HTML
                                </button>
                            </div>
                            <Transition>
                                <div v-if="showPreview === 'html'" class="result-code" style="margin-top: 8px;">
                                    <pre id="html-code-snippet">{{ generateTableHTML }}</pre>
                                </div>
                            </Transition>
                        </div>
                    </div>

                </div>

                <!-- Generic Text/Unstructured Result (Fallback for Flowchart code display) -->
                 <div v-else-if="resultData" class="result-code">
                    <p style="font-size: 14px; color: #666; margin-bottom: 5px;">Raw Output (Check this if Flowchart failed to render):</p>
                    <pre>{{ resultData }}</pre>
                </div>
                
            </div>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <p style="margin-bottom: 5px; font-weight: 600; color: #666;">DEVELOPED BY UZAIR B2B SERVICES</p>
            Powered by UZAIR B2B | Flowcharts rendered by Mermaid.js
        </footer>

    </div>

    <script type="module">
        const { createApp, ref, computed, watch, nextTick } = Vue;

        // --- Global Config Variables (MANDATORY BOILERPLATE) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const apiKey = "AIzaSyB7ZzFlm7lp4ExexV3sZcGyZ76G_AQFVA4"; 

        // --- UTILITY FUNCTIONS ---

        /** Generic fetch function with exponential backoff for API calls. */
        const fetchWithBackoff = async (url, payload, retries = 5, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; 
                        continue;
                    }

                    if (!response.ok) {
                        const errorBody = await response.json().catch(() => ({}));
                        const errorMessage = errorBody.error?.message || `HTTP Error ${response.status}`;
                        throw new Error(errorMessage);
                    }

                    return await response.json();

                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            throw new Error("API call failed after multiple retries.");
        };

        // --- VUE APPLICATION SETUP ---
        createApp({
            setup() {
                // Reactive State
                const content = ref('');
                const outputType = ref('Table'); // 'Table' or 'Flowchart'
                const resultData = ref(null); 
                const errorMessage = ref(null);
                const isLoading = ref(false);
                const message = ref(null);
                const showPreview = ref(null); 

                // Computed Properties
                const tableHeaders = computed(() => {
                    if (Array.isArray(resultData.value) && resultData.value.length > 0) {
                        return Object.keys(resultData.value[0]);
                    }
                    return [];
                });
                
                const mermaidCode = computed(() => {
                    if (typeof resultData.value === 'string') {
                        // Extract content from ```mermaid block if present
                        const match = resultData.value.match(/```mermaid\n([\s\S]*?)\n```/);
                        return match ? match[1].trim() : resultData.value.trim();
                    }
                    return '';
                });

                // Generate self-contained HTML table using simple CSS
                const generateTableHTML = computed(() => {
                    if (!Array.isArray(resultData.value) || resultData.value.length === 0) return '';
                    
                    const headers = tableHeaders.value;
                    let html = '';

                    // 1. Include necessary internal CSS for self-contained styling
                    html += '<style>\n';
                    html += '  .styled-table-container { overflow-x: auto; }\n';
                    html += '  .styled-table { width: 100%; border-collapse: collapse; font-family: sans-serif; border: 1px solid black; }\n';
                    html += '  .styled-table th, .styled-table td { border: 1px solid black; padding: 10px; text-align: left; }\n';
                    html += '  .styled-table thead { background-color: #f0f0f0; color: #333; font-weight: bold; }\n';
                    html += '  .styled-table tbody tr:nth-child(even) { background-color: #f9f9f9; }\n';
                    html += '</style>\n';

                    // 2. Start HTML structure
                    html += '<div class="styled-table-container">\n';
                    html += '  <table class="styled-table">\n'; 

                    // Thead
                    html += '    <thead>\n';
                    html += '      <tr>\n';
                    headers.forEach(key => {
                        html += `        <th>${key}</th>\n`; 
                    });
                    html += '      </tr>\n';
                    html += '    </thead>\n';

                    // Tbody
                    html += '    <tbody>\n';
                    resultData.value.forEach(row => {
                        html += '      <tr>\n';
                        headers.forEach(key => {
                            const value = row[key] !== undefined && row[key] !== null ? String(row[key]) : '';
                            html += `        <td>${value}</td>\n`;
                        });
                        html += '      </tr>\n';
                    });
                    html += '    </tbody>\n';
                    
                    // 3. End structure
                    html += '  </table>\n';
                    html += '</div>';

                    return html;
                });

                // Function to safely retrieve the serialized SVG code
                const getRenderedSvgCode = () => {
                    const container = document.getElementById('mermaid-output');
                    // Look for the first SVG element inside the container
                    const svgElement = container ? container.querySelector('svg') : null;
                    
                    if (!svgElement) {
                        return null;
                    }
                    
                    // Serialize the SVG element to a string
                    return new XMLSerializer().serializeToString(svgElement);
                };

                // Function to handle copying SVG code
                const copySvgCode = () => {
                    const svgCode = getRenderedSvgCode();
                    
                    if (svgCode) {
                        copyToClipboard(svgCode, 'SVG');
                    } else {
                        showMessage("Failed to find rendered SVG code to copy. Please try running the generator first.", 'error');
                    }
                };

                const togglePreview = (type) => {
                    showPreview.value = showPreview.value === type ? null : type;
                };

                const showMessage = (text, type = 'info') => {
                    message.value = { text, type };
                    setTimeout(() => { message.value = null; }, 3000);
                };

                const copyToClipboard = (text, type) => {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.setAttribute('readonly', '');
                    textarea.style.position = 'absolute';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    
                    textarea.select();
                    textarea.setSelectionRange(0, textarea.value.length);
                    
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            showMessage(`${type} code copied successfully!`, 'success');
                        } else {
                            throw new Error('Fallback copy command failed.');
                        }
                    } catch (err) {
                        console.error('Copy failed (execCommand):', err);
                        showMessage(`Failed to copy ${type}. Please try manually selecting and copying the code.`, 'error');
                    } finally {
                        document.body.removeChild(textarea);
                    }
                };


                // Watcher to re-render Mermaid diagram when data changes
                watch(mermaidCode, (newCode) => {
                    if (outputType.value === 'Flowchart' && newCode && !errorMessage.value) {
                        nextTick(() => {
                            const container = document.getElementById('mermaid-output');
                            if (!container) return;
                            
                            // Clear previous content
                            container.innerHTML = `<p style="text-align: center; color: #007bff;">Rendering Flowchart...</p>`;

                            try {
                                // Use Mermaid render method to turn code into SVG
                                mermaid.render('mermaid-svg', newCode)
                                    .then(({ svg }) => {
                                        container.innerHTML = svg;
                                    })
                                    .catch(e => {
                                        console.error("Mermaid Render Error:", e);
                                        container.innerHTML = `<p style="text-align: center; color: red;">Failed to render Flowchart. Raw code is shown below.</p>`;
                                        errorMessage.value = "Flowchart rendering failed. Mermaid code may be invalid or too complex for the renderer.";
                                    });
                            } catch (e) {
                                console.error("General Mermaid Error:", e);
                                container.innerHTML = `<p style="text-align: center; color: red;">A critical error occurred during rendering.</p>`;
                            }
                        });
                    }
                }, { immediate: true });

                // --- CORE LOGIC: API CALL AND PROCESSING ---

                const processContent = async () => {
                    const trimmedContent = content.value.trim();
                    if (!trimmedContent) {
                        showMessage("Please paste some content first.", 'error');
                        return;
                    }

                    isLoading.value = true;
                    errorMessage.value = null;
                    resultData.value = null;
                    showPreview.value = null; 
                    showMessage(`Generating ${outputType.value.toLowerCase()}...`, 'info');

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    let payload;
                    let processResult;

                    if (outputType.value === 'Table') {
                        // 1. Structured Output (Table) Configuration
                        payload = {
                            contents: [{ 
                                parts: [{ 
                                    text: `Analyze the following text and convert the key facts, entities, and relationships into a structured, tabular format suitable for JSON output. The output must be an array of objects. Text to analyze: "${trimmedContent}"` 
                                }] 
                            }],
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "ARRAY",
                                    description: "A table where each object is a row, and properties are columns.",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "Item": { "type": "STRING" },
                                            "Description": { "type": "STRING" },
                                            "Value": { "type": "STRING" },
                                        }
                                    }
                                }
                            },
                        };

                        try {
                            const result = await fetchWithBackoff(apiUrl, payload);
                            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                            if (!jsonText) {
                                throw new Error("API returned no structured content.");
                            }

                            processResult = JSON.parse(jsonText);
                            if (!Array.isArray(processResult) || processResult.length === 0) {
                                throw new Error("Parsed JSON is not a valid array or is empty.");
                            }
                            resultData.value = processResult;
                            showMessage('Table generated successfully!', 'success');

                        } catch (e) {
                            errorMessage.value = `Failed to generate or parse table data: ${e.message}`;
                            console.error("Table Generation Error:", e);
                            showMessage('Error in table generation.', 'error');
                        }

                    } else if (outputType.value === 'Flowchart') {
                        // 2. Unstructured Output (Mermaid Code) Configuration
                        payload = {
                            contents: [{ 
                                parts: [{ 
                                    text: `Analyze the following content and generate the corresponding Mermaid Markdown code for a flowchart or process diagram. Ensure the code is wrapped ONLY in a single \`\`\`mermaid \`\`\` block and clearly visualizes the process or steps described. Do not include any explanatory text outside the code block. Content: "${trimmedContent}"` 
                                }] 
                            }],
                        };

                        try {
                            const result = await fetchWithBackoff(apiUrl, payload);
                            processResult = result.candidates?.[0]?.content?.parts?.[0]?.text;
                            
                            if (!processResult || !processResult.includes('```mermaid')) {
                                throw new Error("API did not return valid Mermaid markdown code block.");
                            }

                            resultData.value = processResult;
                            showMessage('Flowchart code generated successfully! Attempting to render...', 'success');

                        } catch (e) {
                            errorMessage.value = `Failed to generate Mermaid code: ${e.message}`;
                            console.error("Flowchart Generation Error:", e);
                            showMessage('Error in flowchart generation.', 'error');
                        }
                    }

                    isLoading.value = false;
                };

                // --- DOWNLOAD LOGIC ---

                const downloadResult = (format) => {
                    if (!resultData.value) {
                        showMessage("Nothing to download yet.", 'error');
                        return;
                    }

                    let fileData, filename, mimeType;

                    if (format === 'html') {
                        fileData = generateTableHTML.value; 
                        filename = 'table_ai_table_section.html';
                        mimeType = 'text/html';
                        showMessage("HTML code downloaded!", 'success');
                    } else if (format === 'svg') {
                        const svgCode = getRenderedSvgCode();
                        
                        if (!svgCode) {
                            showMessage("Could not find the rendered SVG to download. Please ensure it rendered successfully first.", 'error');
                            return;
                        }

                        fileData = svgCode;
                        filename = 'table_ai_flowchart.svg';
                        mimeType = 'image/svg+xml';
                        showMessage("Flowchart downloaded as SVG!", 'success');
                    } else {
                        return; 
                    }


                    const blob = new Blob([fileData], { type: mimeType });
                    const url = URL.createObjectURL(blob);

                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url); 
                };
                
                // Initialize Mermaid
                mermaid.initialize({ startOnLoad: true, theme: 'neutral' });

                return {
                    content,
                    outputType,
                    resultData,
                    errorMessage,
                    isLoading,
                    message,
                    tableHeaders,
                    mermaidCode,
                    showPreview,
                    generateTableHTML,
                    togglePreview,
                    copyToClipboard, 
                    processContent,
                    downloadResult,
                    copySvgCode, // Expose the new copy function
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
