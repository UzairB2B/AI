<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bhagwat Geeta Chatbot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            height: 90vh; /* Full viewport height for chat layout */
        }
        #chat-window {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            background-color: #fafafa;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #2563eb;
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem;
        }
        .ai-message {
            background-color: #d1fae5;
            color: #065f46;
            align-self: flex-start;
            border-bottom-left-radius: 0.5rem;
        }
        .input-container {
            display: flex;
            gap: 0.5rem;
        }
        .input-field {
            flex-grow: 1;
            padding: 0.75rem;
            border-radius: 9999px;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        .btn-primary {
            background-color: #2563eb;
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-8">
    <div class="container">
        <h1 class="text-3xl sm:text-4xl font-extrabold mb-4 text-center text-gray-800">UZAIR B2B A.I (Bhagwat Geeta Chatbot)</h1>
        <p class="text-gray-600 mb-6 text-center">Ask me questions about the teachings and wisdom of the Bhagwat Geeta.</p>
        
        <div id="chat-window">
            <div class="ai-message">Hello! I am a chatbot here to help you understand the profound wisdom of the Bhagwat Geeta. What would you like to know?</div>
        </div>

        <div class="input-container">
            <input type="text" id="user-input" class="input-field" placeholder="Type your message...">
            <button id="send-btn" class="btn btn-primary flex items-center justify-center">
                <span id="send-btn-text">Send</span>
                <div id="loading-spinner" class="loading-spinner ml-2 hidden"></div>
            </button>
        </div>
    </div>
    
    <footer class="mt-8 text-center text-gray-500 text-sm">
        Made by uzair b2b services
    </footer>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const sendBtnText = document.getElementById('send-btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');

        // This is a placeholder for the API key, which will be provided by the runtime.
        const apiKey = "AIzaSyA8yV9Cwlb5YlM_wseGrDBiInrV_KB4B10";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        /**
         * Adds a new message to the chat window.
         * @param {string} text - The message text.
         * @param {string} sender - The sender, either 'user' or 'ai'.
         */
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.textContent = text;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to the bottom
        }

        /**
         * Fetches a response from the Gemini API with exponential backoff.
         * @param {object} payload - The payload for the API request.
         * @param {number} retries - The number of retries remaining.
         * @param {number} delay - The delay in milliseconds before the next retry.
         */
        async function fetchWithBackoff(payload, retries = 5, delay = 1000) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(payload, retries - 1, delay * 2);
                    } else {
                        throw new Error(`API error: ${response.statusText}`);
                    }
                }

                const result = await response.json();
                return result;

            } catch (error) {
                console.error("API call failed:", error);
                throw error;
            }
        }

        /**
         * Handles the main logic for sending a message and getting a response.
         */
        async function sendMessage() {
            const userText = userInput.value.trim();
            if (!userText) return;

            // Add user message to chat window
            addMessage(userText, 'user');
            userInput.value = ''; // Clear input field

            // Show loading state
            sendBtn.disabled = true;
            sendBtnText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            const prompt = `You are an AI assistant and a scholar of the Bhagwat Geeta. Your sole purpose is to answer questions based on its teachings and wisdom. You must not answer any question that is not related to the Bhagwat Geeta. If a question is not related, politely decline and explain your purpose. Question: ${userText}`;
            
            const chatHistory = [{
                role: "user",
                parts: [{ text: prompt }]
            }];

            const payload = {
                contents: chatHistory,
            };

            try {
                const result = await fetchWithBackoff(payload);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    addMessage(aiResponse, 'ai');
                } else {
                    addMessage("I'm sorry, I was unable to generate a response. Please try again.", 'ai');
                }
            } catch (error) {
                console.error(error);
                addMessage("An error occurred. Please check the console for more details.", 'ai');
            } finally {
                // Hide loading state
                sendBtn.disabled = false;
                sendBtnText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        // Add event listeners
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
