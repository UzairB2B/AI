<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UZAIR History Debug AI</title>
    <!-- Font links for Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CDN for Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CDN for Vue.js to handle reactivity and logic -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar styling for the chat window */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Style for the copy button overlay */
        .copy-btn-wrapper {
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .ai-message-bubble:hover .copy-btn-wrapper {
            opacity: 1;
        }
        /* Hide the default select arrow in browsers for custom styling */
        .custom-select-control {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen bg-gray-100 text-gray-900">
    <!-- Vue.js app container -->
    <div id="app" class="flex flex-col w-full max-w-4xl mx-auto rounded-xl shadow-lg overflow-hidden bg-white mt-6 mb-6 md:mt-12 md:mb-6 h-[80vh] sm:h-[90vh]">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 sm:p-6 border-b border-gray-200 flex-wrap">
            <h1 class="text-xl sm:text-3xl font-extrabold text-gray-900 mb-2 sm:mb-0">HISTORY Debug AI</h1>
            <div class="flex items-center space-x-2">
                <!-- Home button -->
                <a 
                    href="index.html"
                    class="p-2 rounded-full transition-colors duration-200 text-gray-600 hover:bg-gray-200"
                    aria-label="Home"
                >
                    <i class="fas fa-home text-2xl"></i>
                </a>
                <!-- New Chat button -->
                <button
                    @click="resetChat"
                    class="p-2 rounded-full transition-colors duration-200 text-gray-600 hover:bg-gray-200"
                    aria-label="New chat"
                >
                    <i class="fas fa-plus text-2xl"></i>
                </button>
            </div>
            <div class="w-full sm:w-auto mt-2 sm:mt-0 text-right">
                <p class="text-xs sm:text-sm text-gray-500">
                    Made with love by
                    <span class="text-blue-600">uzair b2b services</span>
                </p>
            </div>
        </div>

        <!-- Main Chat Window -->
        <div class="flex-grow overflow-y-auto chat-container p-4 sm:p-6">
            <div v-if="chatHistory.length === 0" class="text-center italic p-8 text-gray-400">
                <p>Welcome! I am your <b>History Debug AI</b>. Select a focus area below and ask me any question about history, including facts, figures, and controversies.</p>
            </div>
            <div v-for="(message, index) in chatHistory" :key="index" :class="[
                'flex',
                message.role === 'user' ? 'justify-end' : 'justify-start'
            ]">
                <div :class="[
                    'max-w-[85%]',
                    'p-3',
                    'sm:p-4',
                    'my-1',
                    'rounded-xl',
                    'shadow-sm',
                    'relative',
                    'group', 
                    message.role === 'user' ? 'text-white bg-blue-600 rounded-br-none' : 'text-gray-900 bg-gray-100 rounded-bl-none ai-message-bubble'
                ]">
                    <pre class="whitespace-pre-wrap font-sans">{{ message.text }}</pre>

                    <!-- Copy to Clipboard Button (only for AI messages) -->
                    <div v-if="message.role !== 'user'" class="copy-btn-wrapper absolute top-1 right-1">
                        <button 
                            @click="copy(message.text)" 
                            class="p-1 rounded-full text-gray-500 bg-gray-100/70 hover:bg-gray-200 hover:text-gray-900 transition-colors shadow" 
                            aria-label="Copy to clipboard"
                        >
                            <i class="fas fa-copy text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Loading indicator message -->
            <div v-if="isLoading" class="flex justify-start">
                <div class="max-w-[85%] p-3 sm:p-4 my-1 rounded-xl shadow-sm relative text-gray-900 bg-gray-100 rounded-bl-none">
                    <div class="flex items-center space-x-2">
                        <svg class="animate-spin h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-sm">Thinking...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Box for temporary status messages -->
        <div v-if="message" :class="['p-3 text-center text-sm font-medium', message.type === 'error' ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800']">
            {{ message.text }}
        </div>

        <!-- Input Section: Category Selector and Chat Input -->
        <div class="p-4 sm:p-6 border-t border-gray-200 flex flex-col space-y-4">
            <!-- Category Selector Dropdown (Professional and Clear Design) -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                <!-- Cleaned up label for consistency -->
                <label for="history-category" class="text-base font-extrabold text-blue-700 flex-shrink-0 w-full sm:w-auto">Select Focus Area:</label>
                
                <!-- Custom-styled Select Wrapper (Retaining professional size) -->
                <div class="relative w-full sm:w-2/3 md:w-1/2">
                    <select 
                        id="history-category" 
                        v-model="selectedCategory" 
                        :disabled="isLoading"
                        class="custom-select-control w-full px-5 py-3 pr-12 border-2 border-blue-600 bg-blue-100 text-blue-800 font-semibold text-base rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 cursor-pointer"
                    >
                        <!-- Options cleaned for consistency -->
                        <option value="Indian History">Indian History (Ancient, Medieval, Modern)</option>
                        <option value="World History">World History (Global Focus)</option>
                    </select>
                    <!-- Custom Dropdown Arrow Icon -->
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-blue-700">
                        <i class="fas fa-chevron-circle-down text-lg"></i>
                    </div>
                </div>
            </div>
            
            <!-- Prompt Input and Send Button -->
            <div class="flex items-center space-x-3">
                <input
                    type="text"
                    v-model="prompt"
                    @keyup.enter="sendMessage"
                    :disabled="isLoading"
                    class="flex-grow w-full px-4 py-3 rounded-full border border-gray-300 bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ease-in-out"
                    :placeholder="'Ask a question about ' + selectedCategory + '...'"
                >
                <button
                    @click="sendMessage"
                    :disabled="isLoading || !prompt.trim()"
                    class="p-3 rounded-full bg-blue-600 text-white font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                    aria-label="Send message"
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-auto text-center text-gray-500 text-sm py-4">
        Made with love by uzair b2b services
    </footer>

    <script>
        const { createApp, ref, nextTick } = Vue;

        createApp({
            setup() {
                // Reactive state variables
                const prompt = ref('');
                const isLoading = ref(false);
                const message = ref(null);
                const chatHistory = ref([]); 
                // State for category selection
                const selectedCategory = ref('Indian History'); 

                // API key MUST be an empty string for the environment
                const apiKey = "AIzaSyAsUxuVqGrR7S3vHw8NST2GF--XOpb4REM"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                // Specialized system instruction for the History Debug AI
                const SYSTEM_INSTRUCTION = `You are a specialized History Expert AI named History Debug AI. Your goal is to provide detailed, well-researched, and balanced historical information, including **facts, figures, dates, and historical context**. You must address all aspects of the user's query, including sensitive or controversial topics, maintaining a neutral and objective tone, backed by evidence. If the current focus is 'Indian History', prioritize details covering ancient, medieval, and modern periods of the subcontinent. If 'World History', cover global events comprehensively.`;

                /**
                 * Helper function to show temporary messages.
                 */
                const showMessage = (text, type = 'info') => {
                    message.value = { text, type };
                    // Use 'bg-green-200' for success messages like copy to clipboard
                    const timeout = type === 'info' ? 1500 : 3000;
                    setTimeout(() => {
                        message.value = null;
                    }, timeout);
                };

                /**
                 * Handles fetching a response from the API with exponential backoff.
                 */
                const fetchWithBackoff = async (payload, retries = 5, delay = 1000) => {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429 && retries > 0) {
                                await new Promise(res => setTimeout(res, delay));
                                return fetchWithBackoff(payload, retries - 1, delay * 2);
                            } else {
                                throw new Error(`API error: ${response.statusText} (${response.status})`);
                            }
                        }

                        const res = await response.json();
                        return res;
                    } catch (error) {
                        if (retries > 0) return {}; 
                        throw error;
                    }
                };

                /**
                 * Scrolls the chat window to the bottom.
                 */
                const scrollToBottom = () => {
                    const chatContainer = document.querySelector('.chat-container');
                    nextTick(() => {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    });
                };

                /**
                 * Copies text to the clipboard using document.execCommand('copy').
                 * @param {string} text The text content to copy.
                 */
                const copy = (text) => {
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = text;
                    document.body.appendChild(tempTextArea);
                    
                    tempTextArea.select();
                    try {
                        document.execCommand('copy');
                        showMessage("Copied to clipboard!", 'info');
                    } catch (err) {
                        console.error('Could not copy text: ', err);
                        showMessage("Failed to copy text.", 'error');
                    } finally {
                        document.body.removeChild(tempTextArea);
                    }
                };


                /**
                 * Sends the user message and fetches an AI response.
                 */
                const sendMessage = async () => {
                    const userText = prompt.value.trim();
                    if (!userText) {
                        showMessage("Please enter a message.", 'error');
                        return;
                    }

                    isLoading.value = true;
                    message.value = null;

                    // Add user message to chat history 
                    chatHistory.value.push({ role: 'user', text: userText });
                    const currentCategory = selectedCategory.value; // Get the selected category
                    prompt.value = '';
                    scrollToBottom();

                    // Modify user prompt to include the selected category for better context
                    const finalUserPrompt = `[Focus: ${currentCategory}] User Query: ${userText}`;
                    
                    // Map local chatHistory to the API format (roles: 'user' -> 'user', 'ai' -> 'model')
                    const apiContents = chatHistory.value.map(msg => ({
                        role: msg.role === 'user' ? 'user' : 'model',
                        // Use the original message for display, but ensure the API content is correct
                        parts: [{ text: msg.text }]
                    }));
                    
                    // IMPORTANT: Replace the last user message with the context-aware one for the API call 
                    // This ensures the model knows the selected category for that specific message.
                    apiContents.pop(); 
                    apiContents.push({ role: 'user', parts: [{ text: finalUserPrompt }] }); 

                    const payload = {
                        // Send the entire chat history for conversational memory
                        contents: apiContents,
                        // Use dedicated system instruction field
                        systemInstruction: {
                            parts: [{ text: SYSTEM_INSTRUCTION }]
                        },
                        // Keep Google Search grounding for up-to-date facts and figures
                        tools: [{ "google_search": {} }],
                    };

                    try {
                        const response = await fetchWithBackoff(payload);
                        const aiResponse = response?.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (aiResponse) {
                            chatHistory.value.push({ role: 'ai', text: aiResponse });
                        } else {
                            chatHistory.value.push({ role: 'ai', text: "Sorry, I couldn't generate a coherent response. Please rephrase your query or try a different history category." });
                            showMessage("Response generation failed.", 'error');
                        }
                    } catch (error) {
                        console.error("Critical API Error:", error);
                        chatHistory.value.push({ role: 'ai', text: "An unrecoverable network error occurred while fetching the response." });
                        showMessage("A network error occurred.", 'error');
                    } finally {
                        isLoading.value = false;
                        scrollToBottom();
                    }
                };

                /**
                 * Resets the application state to a new chat.
                 */
                const resetChat = () => {
                    prompt.value = '';
                    chatHistory.value = [];
                    isLoading.value = false;
                    message.value = null;
                    showMessage(`Starting a new chat on ${selectedCategory.value}.`, 'info');
                };

                return {
                    prompt,
                    isLoading,
                    message,
                    chatHistory,
                    selectedCategory,
                    sendMessage,
                    resetChat,
                    copy 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
