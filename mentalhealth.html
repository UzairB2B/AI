<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mental Health Assistant</title>
    <!-- Font link for Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CDN for Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CDN for Vue.js to handle reactivity and logic -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Font Awesome for send, copy and home icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-window {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* For smooth scrolling on iOS */
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            background-color: #fafafa;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
        }
        .user-message {
            background-color: #2563eb;
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem;
        }
        .ai-message {
            background-color: #d1fae5;
            color: #065f46;
            align-self: flex-start;
            border-bottom-left-radius: 0.5rem;
            position: relative; /* Add this for positioning the copy button */
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Vue.js app container -->
    <div id="app" class="flex flex-col flex-grow w-full max-w-4xl mx-auto rounded-xl shadow-lg overflow-hidden bg-white mt-6 mb-6 md:mt-12 md:mb-6">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 sm:p-6 border-b border-gray-200 flex-wrap">
            <h1 class="text-xl sm:text-3xl font-extrabold text-gray-900 mb-2 sm:mb-0">AI MENTAL HEALTH ASSISTANT</h1>
            <div class="flex items-center space-x-2">
                <!-- Home Button with responsive padding -->
                <a href="#" class="px-3 py-1 sm:px-4 sm:py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold shadow-md hover:bg-gray-300 transition-colors duration-200 flex items-center">
                    <i class="fas fa-home mr-2"></i>
                    Home
                </a>
                <p class="text-xs sm:text-sm text-gray-500">
                    Made by
                    <span class="text-blue-600">uzair b2b services</span>
                </p>
            </div>
        </div>

        <!-- Main Content Section -->
        <div class="p-6 flex flex-col flex-grow w-full">
            <p class="text-gray-600 mb-6 text-center">Your supportive AI for general advice and information on mental well-being.</p>
            
            <!-- Message Box for copy status -->
            <div v-if="message" :class="['rounded-xl px-4 py-2 text-center text-sm font-medium mb-4', message.type === 'error' ? 'bg-red-200 text-red-800' : 'bg-blue-200 text-blue-800']">
                {{ message.text }}
            </div>

            <!-- Chat Window -->
            <div ref="chatWindow" class="chat-window">
                <div class="ai-message">Hello. I'm an AI assistant designed to provide general support and information. I am not a substitute for a licensed mental health professional. If you are in crisis, please contact emergency services or a crisis hotline. How can I help you today?</div>
                <div v-for="(message, index) in chatHistory" :key="index" :class="['message', message.sender === 'user' ? 'user-message' : 'ai-message']">
                    {{ message.text }}
                    <!-- Copy button for AI messages -->
                    <button v-if="message.sender === 'ai'" @click="copyToClipboard(message.text)" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>

            <!-- Input Container -->
            <div class="flex gap-2">
                <input
                    v-model="userMessage"
                    type="text"
                    @keyup.enter="sendMessage"
                    class="flex-grow px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ease-in-out"
                    placeholder="Share how you're feeling..."
                    :disabled="isLoading"
                >
                <button
                    @click="sendMessage"
                    class="px-6 py-3 rounded-full bg-blue-600 text-white font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                    :disabled="isLoading || !userMessage.trim()"
                >
                    <span v-if="!isLoading">Send</span>
                    <svg v-else class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="mt-auto text-center text-gray-500 text-sm py-4">
        Made by uzair b2b services
    </footer>

    <script>
        // Vue application
        const { createApp, ref, computed, nextTick } = Vue;

        createApp({
            setup() {
                // Reactive state variables
                const userMessage = ref('');
                const chatHistory = ref([]);
                const isLoading = ref(false);
                const chatWindow = ref(null);
                const message = ref(null);

                // API key will be provided by the runtime
                const apiKey = "AIzaSyAGW_mo_PI6dOVL0r2V2cfj5I0DJLJzrmw";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                /**
                 * Adds a message to the chat history and scrolls to the bottom.
                 */
                const addMessage = (text, sender) => {
                    chatHistory.value.push({ text, sender });
                    nextTick(() => {
                        chatWindow.value.scrollTop = chatWindow.value.scrollHeight;
                    });
                };

                /**
                 * Helper function to show temporary messages to the user.
                 */
                const showMessage = (text, type = 'info') => {
                    message.value = { text, type };
                    setTimeout(() => {
                        message.value = null;
                    }, 3000);
                };
                
                /**
                 * Handles fetching a response from the API with exponential backoff.
                 */
                const fetchWithBackoff = async (payload, retries = 5, delay = 1000) => {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429 && retries > 0) {
                                await new Promise(res => setTimeout(res, delay));
                                return fetchWithBackoff(payload, retries - 1, delay * 2);
                            } else {
                                throw new Error(`API error: ${response.statusText}`);
                            }
                        }

                        const result = await response.json();
                        return result;
                    } catch (error) {
                        throw error;
                    }
                };

                /**
                 * Sends the user's message and gets a response from the AI.
                 */
                const sendMessage = async () => {
                    const userText = userMessage.value.trim();
                    if (!userText) return;

                    addMessage(userText, 'user');
                    userMessage.value = '';
                    isLoading.value = true;
                    
                    try {
                        // Create the AI prompt with safety instructions
                        const prompt = `You are a compassionate and helpful AI designed to act as a mental health support assistant. Your purpose is to listen, offer empathetic responses, and provide general advice on coping mechanisms, mindfulness, or common emotional challenges. You must always start by saying "Thank you for sharing that with me." You must also include a clear disclaimer at the end that you are not a medical professional and cannot provide a diagnosis or substitute for professional help. If the user expresses a desire to harm themselves or others, immediately provide a crisis hotline number like 988 in the U.S. or other relevant local numbers.
                        
User's message: ${userText}
                        
Based on this, please provide a supportive and informative response.`;

                        const chatHistoryPayload = [{
                            role: "user",
                            parts: [{ text: prompt }]
                        }];
                        const payload = { contents: chatHistoryPayload };

                        const result = await fetchWithBackoff(payload);
                        const aiResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (aiResponse) {
                            addMessage(aiResponse, 'ai');
                        } else {
                            addMessage("I'm sorry, I was unable to generate a response. Please try again.", 'ai');
                        }
                    } catch (error) {
                        console.error(error);
                        addMessage("An error occurred. Please try again.", 'ai');
                    } finally {
                        isLoading.value = false;
                    }
                };

                /**
                 * Copies the given text to the clipboard.
                 */
                const copyToClipboard = (text) => {
                    const el = document.createElement('textarea');
                    el.value = text;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    showMessage("Guidance copied to clipboard!", 'info');
                };


                return {
                    userMessage,
                    chatHistory,
                    isLoading,
                    message,
                    sendMessage,
                    chatWindow,
                    copyToClipboard
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
