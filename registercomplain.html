
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complaint Filing AI</title>
    <!-- Puter JS Library -->
    <script src="https://js.puter.com/v2/"></script>
    <!-- Font links for Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CDN for Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CDN for Vue.js to handle reactivity and logic -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .chat-window {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1.5rem;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            scroll-behavior: smooth;
        }
        /* Message Transition Animation */
        .message-enter-active,
        .message-leave-active {
            transition: all 0.4s ease;
        }
        .message-enter-from,
        .message-leave-to {
            opacity: 0;
            transform: translateY(20px);
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 1rem 1.25rem;
            border-radius: 1.25rem;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        .user-bubble {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #ffffff;
            border-bottom-right-radius: 0.25rem;
        }
        .ai-bubble {
            background-color: #f3f4f6;
            color: #1f2937;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid #e5e7eb;
        }
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }
        .loading-dots span {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Custom Scrollbar */
        .chat-window::-webkit-scrollbar {
            width: 6px;
        }
        .chat-window::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .chat-window::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        .chat-window::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased min-h-screen flex flex-col p-4">

    <!-- Vue.js app container -->
    <div id="app" class="flex flex-col w-full max-w-5xl mx-auto rounded-2xl shadow-xl overflow-hidden bg-white flex-1 max-h-full my-auto">
        <!-- Header -->
        <div class="flex flex-col border-b border-gray-200 bg-white z-10">
            <div class="flex items-center justify-between p-4 sm:p-5">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                        <i class="fas fa-balance-scale text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-lg sm:text-xl font-bold text-gray-900 leading-tight">{{ translate('app_title') }}</h1>
                        <p class="text-xs text-gray-500 hidden sm:block">{{ translate('tagline') }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <select id="chat-language-select" v-model="chatLanguage" @change="resetChat" class="py-1.5 px-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50">
                        <option v-for="(lang, key) in languages" :key="key" :value="key">{{ lang.name }}</option>
                    </select>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="w-full bg-gray-100 h-1.5" v-if="!isInfoCollected">
                <div class="bg-blue-600 h-1.5 transition-all duration-500 ease-out" :style="{ width: progressPercentage + '%' }"></div>
            </div>
        </div>

        <!-- Main Content Section -->
        <div class="flex flex-col flex-grow overflow-hidden relative">
            
            <!-- Message Box for status -->
            <transition name="message">
                <div v-if="message" class="absolute top-4 left-1/2 transform -translate-x-1/2 z-20 px-6 py-3 rounded-full text-sm font-semibold shadow-lg backdrop-blur-sm" 
                    :class="message.type === 'error' ? 'bg-red-100/90 text-red-700 border border-red-200' : 'bg-green-100/90 text-green-700 border border-green-200'">
                    {{ message.text }}
                </div>
            </transition>

            <!-- Chat Window -->
            <div ref="chatWindow" class="chat-window">
                <div class="p-4 mb-2 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm flex items-start gap-3">
                    <i class="fas fa-exclamation-circle mt-0.5 shrink-0"></i>
                    <span>{{ translate('disclaimer') }}</span>
                </div>

                <div v-if="initialMessage" class="flex items-end gap-3 group">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 shrink-0 mb-1">
                        <i class="fas fa-robot text-sm"></i>
                    </div>
                    <div class="message-bubble ai-bubble">
                       {{ initialMessage.text }}
                    </div>
                    <button @click="speak(initialMessage.text)" class="text-gray-400 hover:text-blue-600 transition-all opacity-0 group-hover:opacity-100 ml-1">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
                
                <transition-group name="message">
                    <div v-for="(message, index) in chatHistory" :key="index" class="flex items-end gap-3" :class="message.sender === 'user' ? 'flex-row-reverse' : 'group'">
                        <div class="w-8 h-8 rounded-full shrink-0 mb-1 flex items-center justify-center"
                             :class="message.sender === 'user' ? 'bg-blue-600 text-white' : 'bg-blue-100 text-blue-600'">
                            <i :class="message.sender === 'user' ? 'fas fa-user text-sm' : 'fas fa-robot text-sm'"></i>
                        </div>
                        <div :class="['message-bubble', message.sender === 'user' ? 'user-bubble' : 'ai-bubble', 'group relative']">
                            {{ message.text }}
                            <button v-if="message.sender === 'user' && !isInfoCollected && message.step !== undefined" @click="startEdit(message.step)" class="absolute -bottom-2 -right-2 bg-white rounded-full p-1.5 shadow text-gray-500 hover:text-blue-600 text-xs transition-opacity opacity-0 group-hover:opacity-100">
                                <i class="fas fa-pencil-alt fa-fw"></i>
                            </button>
                        </div>
                         <button v-if="message.sender === 'ai'" @click="speak(message.text)" class="text-gray-400 hover:text-blue-600 transition-all opacity-0 group-hover:opacity-100 ml-1">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                </transition-group>
                
                <div v-if="isGenerating" class="flex items-end gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 shrink-0 mb-1">
                        <i class="fas fa-robot text-sm"></i>
                    </div>
                    <div class="message-bubble ai-bubble flex items-center gap-2">
                        <span>{{ translate('generating_report') }}</span>
                        <div class="loading-dots">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
                
                <!-- Report View -->
                <transition name="message">
                    <div v-if="generatedReport" class="mt-4 border border-gray-200 rounded-xl overflow-hidden shadow-sm bg-white">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-file-alt text-blue-600"></i> {{ translate('generated_report_title') }}
                            </h3>
                            <button @click="downloadPDF" class="text-sm bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded-lg transition-colors">
                                <i class="fas fa-download mr-1"></i> PDF
                            </button>
                        </div>
                        <div class="p-6 bg-white overflow-x-auto">
                            <pre class="whitespace-pre-wrap font-serif text-gray-800 text-sm leading-relaxed">{{ generatedReport }}</pre>
                        </div>
                    </div>
                </transition>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-white border-t border-gray-200">
                <div class="flex flex-col gap-3">
                    <div v-if="isPhotoUploadStep && incidentPhotos.length > 0" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 p-2 bg-gray-50 rounded-lg">
                        <div v-for="photo in incidentPhotos" :key="photo.id" class="relative group">
                            <img :src="photo.base64" class="rounded-md object-cover w-full h-24">
                            <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-md">
                                <button @click="removePhoto(photo.id)" class="text-white text-xl">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                     <!-- Action Buttons Row -->
                    <div v-if="isInfoCollected || generatedReport" class="flex gap-2 justify-center pb-2">
                        <button
                            v-if="isInfoCollected && !generatedReport"
                            @click="generateReport"
                            class="px-5 py-2 rounded-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all text-sm flex items-center gap-2"
                            :disabled="isGenerating"
                        >
                            <i class="fas fa-magic"></i>
                            <span v-if="!isGenerating">{{ translate('generate_report') }}</span>
                            <span v-else>Processing...</span>
                        </button>
                        <button v-if="isInfoCollected" @click="resetChat" class="px-5 py-2 rounded-full bg-white border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-all text-sm flex items-center gap-2">
                            <i class="fas fa-redo-alt"></i> {{ translate('start_over') }}
                        </button>
                    </div>

                    <!-- Conditional Input Area -->
                    <div v-if="!isInfoCollected && !generatedReport">
                        <!-- Photo Upload UI -->
                        <div v-if="isPhotoUploadStep" class="flex flex-col gap-3">
                            <div class="flex flex-col sm:flex-row gap-3">
                                <input type="file" ref="fileInput" @change="handleFileChange" class="hidden" accept="image/*" multiple>
                                <button @click="() => fileInput.click()" class="flex-1 px-4 py-3 text-sm font-semibold text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors flex items-center justify-center gap-2">
                                    <i class="fas fa-upload"></i> {{ translate('upload_photo') }}
                                </button>
                                <button @click="capturePhoto" class="flex-1 px-4 py-3 text-sm font-semibold text-purple-600 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition-colors flex items-center justify-center gap-2">
                                    <i class="fas fa-camera"></i> {{ translate('capture_photo') }}
                                </button>
                            </div>
                            <button @click="advanceConversation" class="w-full px-4 py-3 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 shadow-sm">
                                {{ translate('continue_step') }} <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
    
                        <!-- Standard Text Input UI -->
                        <div v-else class="relative flex items-center">
                            <input
                                ref="inputBox"
                                v-model="userMessage"
                                type="text"
                                @keyup.enter="handleInput"
                                class="w-full pl-5 pr-14 py-4 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm text-gray-700 placeholder-gray-400 bg-gray-50 transition-all"
                                :placeholder="editingStep !== null ? translate('edit_placeholder') : translate('input_placeholder')"
                                :disabled="isLoading || isGenerating"
                            >
                            <button
                                @click="handleInput"
                                class="absolute right-2 p-2.5 rounded-full bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm"
                                :disabled="isLoading || isGenerating || !userMessage.trim()"
                            >
                               <i :class="editingStep !== null ? 'fas fa-check' : 'fas fa-paper-plane'" class="text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            const { createApp, ref, computed, nextTick, onMounted } = Vue;

            const languages = {
                en: { 
                    name: 'English', 
                    questions: [
                        { key: 'name', text: "What is your full name?" },
                        { key: 'contact', text: "What is your contact information (Phone & Address)?" },
                        { key: 'recipient', text: "Who are you addressing this complaint to? (e.g., Station House Officer, College Principal, HR Manager)" },
                        { key: 'subject', text: "What is the specific Subject or Nature of your complaint? (e.g., Theft of Mobile Phone, Workplace Harassment)" },
                        { key: 'accused', text: "What is the full name and address of the person(s) you are complaining against? If unknown, provide a description." },
                        { key: 'date', text: "What was the Date and Time of the incident?" },
                        { key: 'place', text: "Where specifically did the incident take place?" },
                        { key: 'witnesses', text: "Were there any witnesses? If yes, please provide their names and contact details." },
                        { key: 'details', text: "Please describe the incident in chronological detail. What exactly happened?" },
                        { key: 'evidenceDescription', text: "Please describe any evidence you have (e.g., Screenshots, Documents). You can upload photos in the next step." },
                        { key: 'photoEvidence', text: "You can now upload or capture photos as evidence. Add as many as you need, then click 'Continue'. You can also click 'Continue' to skip this step." },
                        { key: 'relief', text: "What specific action or relief are you requesting from the authorities? (e.g., Register FIR, take disciplinary action)" },
                        { key: 'additionalInfo', text: "Is there any other information you would like to add?" }
                    ],
                    app_title: 'Legal Complaint Assistant', 
                    tagline: 'AI-drafting for Police, HR, or Institutional complaints.', 
                    disclaimer: 'Disclaimer: This tool drafts complaints based on your inputs. It is not legal advice. Consult a lawyer for serious matters.',
                    initial_message: 'Hello. I can help you draft a formal legal complaint. To begin, what is your full name?',
                    generating_report: 'Drafting your document...', 
                    generated_report_title: 'Final Draft:', 
                    input_placeholder: 'Type your answer here...',
                    edit_placeholder: 'Enter your updated answer...',
                    report_ready: 'All details collected. Ready to draft?', 
                    generate_report: 'Draft Complaint', 
                    start_over: 'New Complaint',
                    upload_photo: 'Upload Photo',
                    capture_photo: 'Capture Photo',
                    continue_step: 'Continue',
                    photo_description_prompt: 'Please enter a brief description for this photo:',
                    photo_upload_success: 'Photo added successfully!',
                    edit_success: 'Answer updated!',
                    report_error: 'Could not generate report. Please try again.', 
                    api_error: 'Connection error. Please try again.', 
                    download_success: 'Document downloaded successfully!'
                },
                hi: {
                    name: 'हिन्दी',
                    questions: [
                        { key: 'name', text: "आपका पूरा नाम क्या है?" },
                        { key: 'contact', text: "आपकी संपर्क जानकारी और पता क्या है?" },
                        { key: 'recipient', text: "आप यह शिकायत किसे संबोधित कर रहे हैं? (e.g., Station House Officer, College Principal, HR Manager)" },
                        { key: 'subject', text: "आपकी शिकायत का मुख्य विषय क्या है?" },
                        { key: 'accused', text: "जिस व्यक्ति के खिलाफ आप शिकायत कर रहे हैं उसका नाम और पता क्या है?" },
                        { key: 'date', text: "घटना की तारीख और समय क्या था?" },
                        { key: 'place', text: "घटना ठीक कहाँ हुई?" },
                        { key: 'witnesses', text: "क्या कोई गवाह थे? यदि हाँ, तो उनके नाम दें।" },
                        { key: 'details', text: "कृपया घटना का विस्तार से वर्णन करें।" },
                        { key: 'evidenceDescription', text: "कृपया किसी भी सबूत का वर्णन करें। आप अगले चरण में तस्वीरें अपलोड कर सकते हैं।" },
                        { key: 'photoEvidence', text: "अब आप सबूत के तौर पर तस्वीरें अपलोड या कैप्चर कर सकते हैं। अपनी आवश्यकतानुसार फ़ोटो जोड़ें, फिर 'जारी रखें' पर क्लिक करें। आप इस चरण को छोड़ने के लिए भी 'जारी रखें' पर क्लिक कर सकते हैं।" },
                        { key: 'relief', text: "आप अधिकारियों से क्या विशिष्ट कार्रवाई चाहते हैं?" },
                        { key: 'additionalInfo', text: "क्या आप कोई अन्य जानकारी जोड़ना चाहेंगे?" }
                    ],
                    app_title: 'कानूनी शिकायत सहायक',
                    tagline: 'पुलिस या संस्थागत शिकायतों के लिए पेशेवर एआई ड्राफ्टिंग।',
                    disclaimer: 'अस्वीकरण: यह टूल आपके इनपुट के आधार पर ड्राफ्ट बनाता है। यह कानूनी सलाह नहीं है।',
                    initial_message: 'नमस्ते। मैं आपकी औपचारिक शिकायत लिखने में मदद कर सकता हूँ। आपका पूरा नाम क्या है?',
                    generating_report: 'दस्तावेज़ तैयार हो रहा है...',
                    generated_report_title: 'अंतिम ड्राफ्ट:',
                    input_placeholder: 'अपना उत्तर यहाँ लिखें...',
                    edit_placeholder: 'अपना अपडेट किया हुआ उत्तर दर्ज करें...',
                    report_ready: 'सभी जानकारी एकत्र कर ली गई है। ड्राफ्ट बनाएं?',
                    generate_report: 'शिकायत ड्राफ्ट करें',
                    start_over: 'नई शिकायत',
                    upload_photo: 'फोटो अपलोड करें',
                    capture_photo: 'फोटो खींचे',
                    continue_step: 'जारी रखें',
                    photo_description_prompt: 'कृपया इस तस्वीर के लिए एक संक्षिप्त विवरण दर्ज करें:',
                    photo_upload_success: 'फोटो सफलतापूर्वक जोड़ा गया!',
                    edit_success: 'उत्तर अपडेट हो गया!',
                    report_error: 'रिपोर्ट तैयार नहीं हो सकी।',
                    api_error: 'कनेक्शन त्रुटि।',
                    download_success: 'दस्तावेज़ डाउनलोड हो गया!'
                },
            };

            const { jsPDF } = window.jspdf;

            createApp({
                setup() {
                    const userMessage = ref('');
                    const chatHistory = ref([]);
                    const isLoading = ref(false);
                    const isGenerating = ref(false);
                    const message = ref(null);
                    const chatWindow = ref(null);
                    const inputBox = ref(null);
                    const fileInput = ref(null);
                    const generatedReport = ref('');
                    const chatLanguage = ref('en');
                    const isInfoCollected = ref(false);
                    const conversationState = ref(0);
                    const complaintData = ref({});
                    const editingStep = ref(null);
                    const incidentPhotos = ref([]);

                    const questions = computed(() => languages[chatLanguage.value]?.questions || languages['en'].questions);
                    const photoStepIndex = computed(() => questions.value.findIndex(q => q.key === 'photoEvidence'));
                    const isPhotoUploadStep = computed(() => conversationState.value === photoStepIndex.value);
                    const initialMessage = computed(() => ({ text: translate('initial_message') }));

                    const progressPercentage = computed(() => {
                        if (isInfoCollected.value) return 100;
                        return Math.min((conversationState.value / questions.value.length) * 100, 100);
                    });
                    
                    const scrollToBottom = () => {
                        nextTick(() => {
                            if (chatWindow.value) {
                                chatWindow.value.scrollTop = chatWindow.value.scrollHeight;
                            }
                        });
                    };

                    const addMessage = (text, sender, step = null) => {
                        const message = { text, sender, step };
                        if (sender === 'user') {
                            chatHistory.value.push(message);
                        } else {
                            isLoading.value = true;
                            setTimeout(() => {
                                chatHistory.value.push(message);
                                isLoading.value = false;
                                scrollToBottom();
                            }, 500);
                        }
                        scrollToBottom();
                    };
                    
                    const translate = (key) => languages[chatLanguage.value]?.[key] || languages['en'][key];
                    const showMessage = (text, type = 'info') => {
                        message.value = { text, type };
                        setTimeout(() => { message.value = null; }, 3000);
                    };

                    const handleInput = async () => {
                        const userText = userMessage.value.trim();
                        if (isLoading.value || isGenerating.value) return;

                        if (editingStep.value !== null) {
                            if (!userText) return;
                            updateAnswer(userText);
                            return;
                        }
                        
                        if (!userText) return;
                        addMessage(userText, 'user', conversationState.value);
                        userMessage.value = '';
                        collectInfo(userText);
                    };

                    const collectInfo = (text) => {
                        const currentQuestion = questions.value[conversationState.value];
                        complaintData.value[currentQuestion.key] = text;
                        advanceConversation();
                    };
                    
                    const advanceConversation = () => {
                        conversationState.value++;
                        if (conversationState.value < questions.value.length) {
                            addMessage(questions.value[conversationState.value].text, 'ai');
                        } else {
                            isInfoCollected.value = true;
                            addMessage(translate('report_ready'), 'ai');
                        }
                    };
                    
                    const startEdit = (step) => {
                        editingStep.value = step;
                        userMessage.value = complaintData.value[questions.value[step].key];
                        nextTick(() => inputBox.value.focus());
                    };

                    const updateAnswer = (newText) => {
                        const step = editingStep.value;
                        const questionKey = questions.value[step].key;
                        complaintData.value[questionKey] = newText;
                        
                        const msgIndex = chatHistory.value.findIndex(m => m.step === step && m.sender === 'user');
                        if (msgIndex > -1) {
                            chatHistory.value[msgIndex].text = newText;
                        }
                        
                        userMessage.value = '';
                        editingStep.value = null;
                        showMessage(translate('edit_success'), 'success');
                    };
                    
                    const handleFileChange = (event) => {
                        const files = event.target.files;
                        if (!files) return;
                        for (const file of files) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const description = prompt(translate('photo_description_prompt'));
                                incidentPhotos.value.push({ id: Date.now(), base64: e.target.result, description: description || "No description" });
                                showMessage(translate('photo_upload_success'), 'success');
                            };
                            reader.readAsDataURL(file);
                        }
                        fileInput.value.value = ''; // Reset for same file selection
                    };

                    const capturePhoto = async () => {
                        try {
                            const photo = await puter.camera.getPicture({ format: 'base64' });
                            if (photo) {
                                const description = prompt(translate('photo_description_prompt'));
                                const base64Image = `data:image/jpeg;base64,${photo}`;
                                incidentPhotos.value.push({ id: Date.now(), base64: base64Image, description: description || "Captured photo" });
                                showMessage(translate('photo_upload_success'), 'success');
                            }
                        } catch(e) {
                            console.error("Camera error:", e);
                            showMessage("Could not access camera.", "error");
                        }
                    };
                    
                    const removePhoto = (id) => {
                        incidentPhotos.value = incidentPhotos.value.filter(p => p.id !== id);
                    };

                    const speak = (text) => {
                        if ('speechSynthesis' in window) {
                            speechSynthesis.cancel(); // Stop any previous speech
                            const utterance = new SpeechSynthesisUtterance(text);
                            utterance.lang = chatLanguage.value === 'hi' ? 'hi-IN' : 'en-US';
                            speechSynthesis.speak(utterance);
                        } else {
                            showMessage('Text-to-speech is not supported in your browser.', 'error');
                        }
                    };

                    const generateReport = async () => {
                        isGenerating.value = true;
                        
                        const photoDescriptions = incidentPhotos.value.map((p, i) => `  - Photo ${i+1}: ${p.description}`).join('\n');
                        const evidenceText = `${complaintData.value.evidenceDescription || 'N/A'}\n${photoDescriptions ? `Photographic Evidence:\n${photoDescriptions}` : ''}`;
                        
                        const prompt = `Based on the following information, draft a comprehensive, formal, and legally sound complaint letter.

**Data provided by user:**
* Recipient: ${complaintData.value.recipient}
* Subject: ${complaintData.value.subject}
* Complainant: ${complaintData.value.name}
* Contact: ${complaintData.value.contact}
* Accused: ${complaintData.value.accused}
* Date: ${complaintData.value.date}
* Place: ${complaintData.value.place}
* Witnesses: ${complaintData.value.witnesses}
* Details: ${complaintData.value.details}
* Evidence Description: ${evidenceText.trim()}
* Relief Sought: ${complaintData.value.relief}
* Additional: ${complaintData.value.additionalInfo}

**Instructions:**
1. Structure the letter professionally with Recipient, Date, Subject, Salutation, Body paragraphs detailing the incident, a section for Prayer/Relief, and a closing with the complainant's details. Ensure the tone is formal.
2. After the main body, add a new section titled "Suggested Legal Actions (as per Indian Law)".
3. In this new section, based on the complaint's subject and details, suggest potential legal actions and cite relevant sections of the Indian Penal Code (IPC) or other applicable Indian laws (e.g., IT Act for cybercrime, etc.).
4. Output strictly plain text formatted for a document.`;
                        
                        try {
                            const response = await puter.ai.chat(prompt);
                            const text = (response && response.message && response.message.content) ? response.message.content : String(response);
                            generatedReport.value = text.trim();
                        } catch (error) {
                            console.error("Puter AI Error:", error);
                            addMessage(translate('api_error'), 'ai');
                        } finally {
                            isGenerating.value = false;
                        }
                    };
                    
                    const downloadPDF = async () => {
                        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                        doc.setFont("times", "roman");
                        doc.setFontSize(12);
                        
                        const margin = 20;
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const pageHeight = doc.internal.pageSize.getHeight();
                        const maxLineWidth = pageWidth - (margin * 2);
                        let y = margin;

                        const addText = (text) => {
                            const lines = doc.splitTextToSize(text, maxLineWidth);
                            lines.forEach(line => {
                                if (y > pageHeight - margin) {
                                    doc.addPage();
                                    y = margin;
                                }
                                doc.text(line, margin, y);
                                y += 7; // Line height
                            });
                        };
                        
                        addText(generatedReport.value);

                        if (incidentPhotos.value.length > 0) {
                            doc.addPage();
                            y = margin;
                            doc.setFont("helvetica", "bold");
                            doc.text("Appendix: Photographic Evidence", margin, y);
                            y += 10;
                            doc.setFont("times", "roman");

                            for (const photo of incidentPhotos.value) {
                                const img = new Image();
                                img.src = photo.base64;
                                await new Promise(resolve => img.onload = resolve);
                                
                                let imgWidth = img.width;
                                let imgHeight = img.height;
                                const ratio = imgWidth / imgHeight;

                                if (imgWidth > maxLineWidth) {
                                    imgWidth = maxLineWidth;
                                    imgHeight = imgWidth / ratio;
                                }

                                const textLines = doc.splitTextToSize(photo.description || 'No description.', maxLineWidth);
                                const textHeight = textLines.length * 7;
                                const requiredSpace = imgHeight + textHeight + 10;
                                
                                if (y + requiredSpace > pageHeight - margin) {
                                    doc.addPage();
                                    y = margin;
                                }

                                const imgData = photo.base64;
                                // Extracts 'jpeg' or 'png' from 'data:image/jpeg;base64'
                                const format = imgData.substring(imgData.indexOf('/') + 1, imgData.indexOf(';base64'));
                                const imgFormat = format.toUpperCase();

                                // For JPEG, we explicitly set compression to 'NONE' to avoid quality loss.
                                // For other formats like PNG, this setting is ignored.
                                doc.addImage(imgData, imgFormat, margin, y, imgWidth, imgHeight, undefined, 'NONE');
                                y += imgHeight + 5;
                                addText(photo.description || 'No description.');
                                y += 5;
                            }
                        }

                        doc.save("Formal_Complaint.pdf");
                        showMessage(translate('download_success'), 'success');
                    };

                    const resetChat = () => {
                        if ('speechSynthesis' in window) {
                            speechSynthesis.cancel();
                        }
                        chatHistory.value = [];
                        userMessage.value = '';
                        conversationState.value = 0;
                        complaintData.value = {};
                        isInfoCollected.value = false;
                        generatedReport.value = '';
                        editingStep.value = null;
                        incidentPhotos.value = [];
                        addMessage(questions.value[0].text, 'ai');
                    };
                    
                    onMounted(() => {
                        resetChat();
                    });

                    return {
                        userMessage, chatHistory, handleInput, isLoading, isGenerating, isInfoCollected,
                        chatWindow, generatedReport, generateReport, downloadPDF, resetChat, message,
                        languages, chatLanguage, translate, progressPercentage, editingStep, startEdit,
                        isPhotoUploadStep, incidentPhotos, handleFileChange, capturePhoto, removePhoto,
                        fileInput, inputBox, initialMessage, advanceConversation, speak
                    };
                }
            }).mount('#app');
        </script>
    </div>
</body>
</html>
